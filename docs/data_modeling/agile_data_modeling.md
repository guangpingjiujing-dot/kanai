# アジャイルデータモデリング

## とりあえずデータを集めてから考えるではなぜだめなのか

「とりあえずデータを集めてから考える」というアプローチは、一見すると効率的に見えるが、実際には多くの問題を引き起こす。

### 開発工数がかかる

#### ELT ワークフローの負債化

ELT 手法の標準化やナレッジが蓄積される前に多数のデータソースからの ELT ワークフローを作成すると、負債となる。一度作成した後にリファクタリングする場合も工数が増大する。

- 各データソースごとに異なる実装パターンが生まれる
- 統一されたナレッジがなく、メンテナンスが困難となる
- リファクタリング時に影響範囲が広く、工数が膨らむ

#### BI ツールへの負荷と mart テーブルの必要性

BI ツールに負荷をかけないため、BI ツールにはロジックを持たせすぎない方が良い。そのためには **mart テーブル**が必要となるが、mart テーブルは source データを変換しないと基本的には作成できない。

**問題点：**

- BI ツールにロジックを持たせすぎた場合：

  - 各ダッシュボード間で数値が異なる
  - ダッシュボードのパフォーマンスが低下する
  - 低品質、低い可用性となる

- mart を作成しない場合：

  - 活用されていない source データだけが蓄積される

- 全ての source に対して mart テーブルを作成する場合：
  - dbt の model 数が莫大となる
  - 開発工数が増大する

#### OLTP データの分析への変換が必要

- 基本的に source データのほとんどは **OLTP（Online Transaction Processing）のデータ**
- 分析のために使用するにはデータモデリングが必須となる。Fabric データベースに集約しただけでは不十分。

**OLTP と OLAP の違い：**

- **OLTP**: トランザクション処理に最適化されたデータ構造（正規化されたテーブル、高速な INSERT/UPDATE/DELETE）
- **OLAP**: 分析処理に最適化されたデータ構造（非正規化、集計に適した構造）

#### 分析要件を満たさない可能性

- ダッシュボードを作成しても、分析の要件を満たしていない、もしくは分析に必要ないものとなる可能性がある。
- 以下の資料にある通り、分析要件を先に決めることが重量
  - [ダッシュボードガイドブック](https://www.digital.go.jp/resources/dashboard-guidebook)

#### YAGNI 原則の適用

- ソフトウェア開発では **YAGNI 原則（You Aren't Going to Need it）**があるが、データ活用分野でも同様
- 必要となる前に作成すると、無駄な工数が発生する。

### 運用負荷が大きい

#### データパイプラインのエラー

データパイプラインのエラーは頻繁に発生する。

- データソースのスキーマ変更
- データ品質の問題（NULL 値、型の不一致など）
- ネットワーク障害やタイムアウト
- データ量の急増による処理時間の増加
- エラー時のバックフィル、リカバリ対応

#### source データのスキーマ変更

source データのスキーマ変更は頻繁に発生する。特に IoT のデータなどが代表的

- カラムの追加・削除
- データ型の変更
- これらの変更に対応するには、各データパイプラインを修正する必要があり、運用負荷が大きくなる。

#### データガバナンスの問題

データガバナンスが不十分になる可能性がある。

- PII（Personally Identifiable Information）情報が放置される
- データオーナーの分からないデータが存在する
- データの更新頻度や品質が不明確
- データの利用規約やセキュリティポリシーが不明確
- Observability が下がる

---

## データモデリングの必要性について

### OLTP データを分析用に変換する具体例

#### 例：EC サイトの注文データ

**OLTP のデータ構造（正規化されたテーブル）：**

```
orders テーブル
- order_id
- customer_id
- order_date
- status

order_items テーブル
- order_item_id
- order_id
- product_id
- quantity
- unit_price

customers テーブル
- customer_id
- name
- email
- registered_date

products テーブル
- product_id
- name
- category_id
- price

categories テーブル
- category_id
- name
```

この構造は、トランザクション処理には最適であるが、分析には向いていない。

**分析したい内容の例：**

- 「月別のカテゴリ別売上」
- 「新規顧客と既存顧客の購入傾向の違い」
- 「商品の売上ランキング」

これらの分析を行うには、複数のテーブルを JOIN する必要があり、クエリが複雑となる。

**分析用のデータ構造（ディメンショナルモデル）：**

```
fact_orders テーブル（ファクトテーブル）
- order_id
- order_item_id
- customer_id
- product_id
- order_date_key
- quantity
- unit_price
- total_amount
- status

dim_customers テーブル（ディメンションテーブル）
- customer_id
- name
- email
- registered_date
- is_new_customer

dim_products テーブル（ディメンションテーブル）
- product_id
- name
- category_id
- category_name

dim_date テーブル（ディメンションテーブル）
- date_key
- year
- month
- quarter
- day_of_week
```

この構造であれば、分析クエリが簡潔になり、パフォーマンスも向上する。

### ファクトテーブルの種類

fact テーブルには複数の種類があり、各ファクトテーブルに合わせてモデリングする必要がある。

#### 1. トランザクションファクトテーブル（Transaction Fact Table）

**特徴：**

- ビジネスイベントが発生した時点のデータを記録
- 一度記録されたら更新されない（イミュータブル）
- 最も一般的なファクトテーブル

**例：**

- 注文ファクトテーブル：注文が確定した時点のデータ
- 決済ファクトテーブル：決済が完了した時点のデータ
- ページビューファクトテーブル：ページが閲覧された時点のデータ

**データ構造：**

```
fact_orders
- order_id
- order_date_key
- customer_id
- product_id
- quantity
- unit_price
- total_amount
```

#### 2. スナップショットファクトテーブル（Snapshot Fact Table）

**特徴：**

- 特定の時点での状態を記録
- 定期的にスナップショットを取得（例：毎日、毎週、毎月）
- 時系列での変化を追跡可能である

**例：**

- 在庫スナップショット：毎日の在庫数量
- 口座残高スナップショット：毎日の残高
- 会員数スナップショット：毎日の会員数

**データ構造：**

```
fact_inventory_snapshot
- snapshot_date_key
- product_id
- warehouse_id
- quantity_on_hand
```

#### 3. 累積スナップショットファクトテーブル（Accumulating Snapshot Fact Table）

**特徴：**

- プロセスの開始から完了までの複数の時点を記録
- プロセスの各ステップの日付を保持
- プロセスの進行状況を追跡可能である

**例：**

- 注文プロセス：注文日、出荷日、配送日、到着日
- 採用プロセス：応募日、面接日、内定日、入社日
- 案件プロセス：商談開始日、提案日、契約日、完了日

**データ構造：**

```
fact_order_process
- order_id
- order_date_key
- ship_date_key
- delivery_date_key
- arrival_date_key
- days_to_ship
- days_to_delivery
- days_to_arrival
```

### ファクトテーブルの種類と開発工数

これらの異なる種類のファクトテーブルを実現するには、dbt モデル数も増加する。その結果、開発工数や運用負荷が大きくなる。

- 各ファクトテーブルごとに dbt モデルが必要
- 各ファクトテーブルの種類に応じた変換ロジックが必要
- テストやドキュメントの整備も必要

**例：EC サイトの場合**

- トランザクションファクト：注文、決済、返品
- スナップショットファクト：在庫、会員数
- 累積スナップショットファクト：注文プロセス、配送プロセス

これらすべてを実装すると、dbt モデル数は数十から数百に及ぶ可能性がある。

- 参考
  - [Microsoft Fabric - ディメンショナルモデリングのファクトテーブル](https://learn.microsoft.com/ja-jp/fabric/data-warehouse/dimensional-modeling-fact-tables)

---

## アジャイルデータモデリングについて

- 以上のことを踏まえ、先に分析要件を決め、分析ニーズに合わせて柔軟にデータモデリングをすることが重要である。
- その方法論として**アジャイルデータモデリング**について説明する。

### そもそもアジャイルとは

**アジャイル（Agile）**は、ソフトウェア開発の手法の一つで、以下の特徴がある：

- **反復的・漸進的**：小さなサイクルで開発を進める
- **変化への対応**：要件の変更に柔軟に対応する
- **顧客との協調**：顧客と密にコミュニケーションを取りながら開発する
- **動作するソフトウェア**：完璧な計画よりも、動作するものを優先する

**従来のウォーターフォール型との違い：**

| ウォーターフォール型   | アジャイル型           |
| ---------------------- | ---------------------- |
| 最初に全ての要件を定義 | 小さな単位で要件を定義 |
| 計画を重視             | 変化への対応を重視     |
| 後戻りが困難           | 後戻りが容易           |
| 長期間の開発           | 短期間のサイクル       |

### アジャイルデータモデリングの概要

**アジャイルデータモデリング**は、アジャイルの考え方をデータモデリングに適用した手法である。

**特徴：**

- **分析要件を先に決める**：データを集める前に、何を分析したいかを明確にする
- **小さな単位でモデリング**：一度に全てのデータをモデリングするのではなく、分析要件に応じて必要な部分だけをモデリングする
- **反復的に改善**：モデルを使用しながら、必要に応じて改善する
- **ユーザー(ビジネス側)も巻き込む**：データモデリングのプロセスにビジネス側のユーザーも参加させ、要件の理解を深めながら進める

**メリット：**

- 開発工数の削減：必要な部分だけをモデリングするため
- 運用負荷の削減：必要なデータだけを管理するため
- 分析要件との整合性：分析要件に基づいてモデリングするため

### ディメンショナルマトリクスについての説明

**ディメンショナルマトリクス**は、ビジネスプロセスと分析の観点（ディメンション）を整理するためのツールである。

#### ディメンショナルマトリクスの構造

| ビジネスプロセス | 分析の観点（ディメンション） |
| ---------------- | ---------------------------- |
| 注文             | 顧客、商品、日付、チャネル   |
| 決済             | 顧客、決済方法、日付         |
| 配送             | 商品、配送先、日付、配送業者 |

#### 具体例：Salesforce のような営業系のデータ

営業活動を例に、ディメンショナルマトリクスを作成する。

**ビジネスプロセス：**

- 商談（Opportunity）
- 案件（Case）
- 活動履歴（Activity）

**分析の観点（ディメンション）：**

- **Who（誰）**: 営業担当者、顧客、アカウント
- **What（何）**: 商品、サービス、ソリューション
- **When（いつ）**: 日付、四半期、年度
- **Where（どこ）**: 地域、支店、営業所
- **Why（なぜ）**: 商談ステージ、案件ステータス、活動タイプ
- **How（どのように）**: チャネル、媒体、アプローチ方法

**ディメンショナルマトリクスの例：**

| 集計対象 (Fact) | 営業担当者 | 顧客 | アカウント | 商品 | サービス | 日付 | 地域 | 支店 | 商談ステージ | 案件ステータス | 活動タイプ | チャネル |
| --------------- | ---------- | ---- | ---------- | ---- | -------- | ---- | ---- | ---- | ------------ | -------------- | ---------- | -------- |
| 商談            | ✓          | ✓    | -          | ✓    | ✓        | ✓    | ✓    | ✓    | ✓            | -              | -          | ✓        |
| 案件            | ✓          | ✓    | ✓          | ✓    | ✓        | ✓    | ✓    | -    | -            | ✓              | -          | ✓        |
| 活動履歴        | ✓          | ✓    | -          | -    | -        | ✓    | ✓    | -    | -            | -              | ✓          | -        |

- このマトリクスにより、どのビジネスプロセスに対して、どのディメンションで分析する必要があるかが明確になる
- また優先的に整備するべきディメンション(適合ディメンション)も明確になる

#### 適合ディメンションとは

**適合ディメンション（Conformed Dimension）**は、複数のファクトテーブル（ビジネスプロセス）で共通して使用されるディメンションテーブルのことである。

**例：**

- **日付ディメンション**：商談、案件、活動履歴など、ほぼすべてのビジネスプロセスで使用される
- **顧客ディメンション**：商談、案件など、複数のビジネスプロセスで使用される
- **営業担当者ディメンション**：商談、案件、活動履歴など、複数のビジネスプロセスで使用される

#### 適合ディメンションを使用する場合の注意点

**1. 定義の統一**

- 複数のファクトテーブルで使用されるため、ディメンションの定義（カラム名、データ型、値の意味など）を統一する必要がある
- 定義が異なると、異なるファクトテーブル間で分析結果の整合性が取れなくなる

**3. マスターデータとしての管理**

- データの整合性を保つため、マスターデータとして一元管理する必要がある
- 更新頻度や更新方法を明確にし、データ品質を保つ仕組みを整備する

### BEAM\*テーブルについて説明

**BEAM\***は、**Business Event Analysis & Modeling**の略で、ビジネスイベントを分析してモデリングする手法である。

#### BEAM\*テーブルの特徴

BEAM\*テーブルは、ビジネスイベントを記録するためのテーブルで、以下の特徴がある：

- **ビジネスイベントを記録**：実際に発生したビジネスイベントを記録する
- **7W 分析**：Who, What, When, Where, Why, How Many, How の観点で整理する
- **イベント単位**：1 つのイベントが 1 行となる

- 参考
  - [30 分でわかる『アジャイルデータモデリング』](https://speakerdeck.com/hanon52_/30fen-dewakaru-aziyairudetamoderingu?slide=24)
  - [タイミーのデータモデリング事例(動画 12 分あたり)](https://www.youtube.com/watch?v=XvXFfEEdvik)

#### 7W 分析の例：注文イベント

| 7W           | 内容       | 例                                                                  |
| ------------ | ---------- | ------------------------------------------------------------------- |
| **Who**      | 誰が       | 顧客（customer_id）                                                 |
| **What**     | 何を       | 商品（product_id）                                                  |
| **When**     | いつ       | 注文日時（order_timestamp）                                         |
| **Where**    | どこで     | チャネル（channel_id）、配送先（shipping_address_id）               |
| **Why**      | なぜ       | キャンペーン（campaign_id）、プロモーションコード（promotion_code） |
| **How Many** | いくら     | 数量（quantity）、金額（amount）                                    |
| **How**      | どのように | 決済方法（payment_method_id）、配送方法（shipping_method_id）       |

#### BEAM\*テーブルの構造例

**注文イベントの BEAM\*テーブル：**

```
beam_orders
- event_id (主キー)
- event_timestamp (When)
- customer_id (Who)
- product_id (What)
- channel_id (Where)
- shipping_address_id (Where)
- campaign_id (Why)
- promotion_code (Why)
- quantity (How Many)
- unit_price (How Many)
- total_amount (How Many)
- payment_method_id (How)
- shipping_method_id (How)
```

#### BEAM\*テーブルのメリット

- **分析の観点が明確**：7W 分析により、分析の観点、スコープが明確となる
  - スコープ：いつからのデータが必要か、どの範囲のデータが必要かなど
- **直感的**：非エンジニアからしても直感的でわかりやすい
  - スタースキーマの解釈にはある程度の専門性が必要
  - BEAM\*テーブルでも難しい場合は mock となるダッシュボードを先につくり、そこから BEAM\*テーブルにおこす
- **拡張が容易**：新しい分析の観点を追加しやすい

#### BEAM\*テーブルと wide テーブルの関係

**BEAM\*テーブルは wide テーブルのイメージに近い**テーブルである。

**wide テーブルとは：**

wide テーブルは、**スタースキーマのファクトテーブルとディメンションテーブルを JOIN して、1 つのテーブルにまとめた非正規化されたテーブル**である。分析しやすいように、必要な情報をすべて 1 つのテーブルに集約した構造となっている。

**wide テーブルの特徴：**

- **非正規化された構造**：複数のテーブルを JOIN した結果を 1 つのテーブルにまとめている
- **分析に最適化**：JOIN が不要で、クエリが簡潔になる
- **多くのカラムを持つ**：ファクトテーブルのメジャー（数値）と、複数のディメンションテーブルの属性が 1 つのテーブルに含まれる

**wide テーブルとスタースキーマ、mart テーブルの関係：**

データモデリングの流れは以下のようになる：

```
1. BEAM*テーブル（ビジネスイベントを記録）
   ↓
2. スタースキーマ（ファクトテーブル + ディメンションテーブル）
   - fact_orders（ファクトテーブル）
   - dim_customers（ディメンションテーブル）
   - dim_products（ディメンションテーブル）
   - dim_date（ディメンションテーブル）
   ↓
3. martテーブル（ビジネスユーザーが直接分析に使用するテーブル）
   a. wideテーブル（martテーブルの一種）
      - スタースキーマのファクトテーブルとディメンションテーブルをJOIN
      - 分析に必要な情報を1つのテーブルに集約
      - 例：mart_orders_wide
   b. 通常のmartテーブル（特定の分析の切り口で集約されたテーブル）
      - スタースキーマの構造（ファクトテーブル + ディメンションテーブル）を維持しつつ、特定の分析の切り口で集約
      - ビジネス領域に特化し、よく使う分析パターンに合わせて事前に集約されたテーブル
      - 例：mart_monthly_category_sales（月別・カテゴリ別の売上集計）、mart_customer_segment_sales（顧客セグメント別の売上集計）
```

**wide テーブルと mart テーブル：**

- **mart テーブル**：ビジネスユーザーが直接分析に使用するテーブルで、特定のビジネス領域（例：売上、顧客、商品）に特化したテーブル
  - **wide テーブル**：mart テーブルの一種で、スタースキーマから作成される非正規化されたテーブル。ファクトテーブルとディメンションテーブルを JOIN して 1 つのテーブルにまとめた構造
  - **通常の mart テーブル**：mart テーブルの一種で、スタースキーマの構造（ファクトテーブル + ディメンションテーブル）を維持しつつ、特定の分析の切り口（例：月別・カテゴリ別、顧客セグメント別など）で集約されたテーブル。よく使う分析パターンに合わせて事前に集約されているため、クエリが簡潔になる
- **スタースキーマ**：正規化された構造で、ファクトテーブルとディメンションテーブルが分離されている

**wide テーブルとスタースキーマのモデリング階層における位置づけ：**

データモデリングには、**概念モデル（概念スキーマ）**、**論理モデル（論理スキーマ）**、**物理モデル（物理スキーマ）**という階層がある。

- **概念モデル（概念スキーマ）**：ビジネスの観点から見たデータの構造。ビジネスユーザーにとって理解しやすく、ビジネスの要件を表現したもの
- **論理モデル（論理スキーマ）**：データベース設計の観点から見たデータの構造。正規化やデータの整合性などが考慮されたもの
- **物理モデル（物理スキーマ）**：実際のデータベース実装の構造。インデックスやパーティションなど、パフォーマンス最適化が考慮されたもの

**wide テーブルとスタースキーマの関係：**

- **wide テーブル**：**概念モデル（概念スキーマ）に近い**構造

  - ビジネスユーザーにとって理解しやすい（1 つのテーブルに必要な情報がすべて含まれている）
  - 非正規化されており、ビジネスの観点から見たデータの構造をそのまま表現
  - 分析の際に JOIN が不要で、直感的にクエリを書ける

- **スタースキーマ**：**論理モデル（論理スキーマ）に近い**構造
  - データベース設計の観点から見た構造（ファクトとディメンションの分離）
  - 正規化の考え方が入っており、データの整合性や再利用性を考慮
  - 柔軟な分析が可能だが、JOIN が必要で、ある程度の専門性が求められる

**モデリングの流れ：**

```
概念モデル（概念スキーマ）
  ↓ BEAM*テーブル、wideテーブル
論理モデル（論理スキーマ）
  ↓ スタースキーマ
物理モデル（物理スキーマ）
  ↓ 実際のデータベース実装
```

**BEAM\*テーブルと wide テーブルの類似点：**

- **1 つのテーブルに多くの情報を含む**：BEAM\*テーブルも wide テーブルも、1 つのテーブルに多くのカラムを持つ
- **分析に適した構造**：どちらも分析しやすいように設計されている
- **非正規化された構造**：正規化よりも分析のしやすさを優先した構造

**BEAM\*テーブルと wide テーブルの違い：**

- **BEAM\*テーブル**：ビジネスイベントを記録するためのテーブルで、7W 分析に基づいて設計される。スタースキーマを作成する前の段階のテーブル
- **wide テーブル**：スタースキーマから作成される分析用のテーブルで、mart テーブルの一種。スタースキーマを作成した後の段階のテーブル

### BEAM\*テーブルができたらそれをディメンショナルモデリングしていく

BEAM\*テーブルができたら、それを**ディメンショナルモデリング**する。

#### ディメンショナルモデリングとは

**ディメンショナルモデリング**は、データ分析のためのデータモデリング手法で、以下の特徴がある：

- **ファクトテーブルとディメンションテーブル**：データを「ファクト（事実）」と「ディメンション（分析の観点）」に分ける
- **スタースキーマ**：ファクトテーブルを中心に、複数のディメンションテーブルが星のように配置される構造
- **理解しやすい**：ビジネスユーザーにとって理解しやすい構造
- **クエリが簡潔**：分析用のクエリが簡潔となる

-----
- 他参考
  - [逆スタースキーマ](https://qiita.com/shinyama/items/0567425a4a47ad7d6efa)  
  - [アジャイルデータモデリングの実践例](https://www.youtube.com/watch?v=awu5YnFhfkQ)
