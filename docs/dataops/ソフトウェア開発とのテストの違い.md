# ソフトウェア開発とのテストの違い

このドキュメントでは、ソフトウェア開発におけるテストとデータエンジニアリングにおけるテストの違いについて説明します。

---

## 概要

ソフトウェア開発とデータエンジニアリングでは、テストの目的とアプローチが大きく異なります。

**ソフトウェア開発**:
- ロジックが壊れていないか（関数・メソッドの振る舞い）を検証

**データエンジニアリング**:
- データの意味・形・信頼性が壊れていないかを検証

そのため、pytestのような「この入力 → この出力」という形式のテストは、データエンジニアリングでは一部の場面でしか使用されません。

---

## 最も重要な違い：正解が固定されていない

### ソフトウェア開発の場合

アプリケーションの関数では、入力に対する出力が常に同じです：

```
add(2, 3) == 5  ← 永遠に正解
```

### データエンジニアリングの場合

データ基盤では、データの値が日々変化するため、固定の正解値が存在しません：

```
今日の売上集計結果 == ？？？
```

売上は毎日変わるため、「期待値が5である」というような固定の正解値によるテストは適用できません。

---

## データエンジニアリングのテストの種類

データエンジニアリングにおけるテストは、以下の4種類に分類できます。

### 1. スキーマテスト（構造の保証）

データの構造が壊れていないかを検証するテストです。

| チェック例 | 何を防ぐ？ |
|--------|--------|
| カラムが消えていない | upstream変更事故 |
| データ型が変わっていない | int→string事故 |
| NULL禁止カラムにNULLがない | 欠損バグ |

この種のテストは、pytestではなく**dbt test**や**Great Expectations**などのデータ品質テストツールで実現します。

### 2. データ品質テスト（値の妥当性）

データの値が妥当な範囲内にあるかを検証するテストです。

**例**:
- 年齢が0未満の人がいない
- 注文日が未来日ではない
- ユーザーIDが重複していない

このテストは、「正解の値」を検証するのではなく、「壊れていない範囲か？」を確認するものです。

### 3. 分布・傾向テスト（統計的監視）

データの分布や傾向に異常がないかを検証するテストです。これはソフトウェア開発のテストと最も異なる点です。

| テスト内容 | 例 |
|--------|---|
| 件数が急減していないか | 前日比 -90% |
| 平均値が異常でないか | 平均売上が10倍 |
| カテゴリ比率が変化していないか | 男性比率90%→10% |

これは「バグ」というより、**データ事故の検知**に近い性質を持ちます。

### 4. 変換ロジックのテスト（pytest的なアプローチ）

データ変換のロジックが正しく動作するかを検証するテストです。これはソフトウェア開発のテストに最も近い形式です。

**例**:
- 日付フォーマット変換
- ステータス変換ロジック
- ETLの関数

この種のテストは、pytestなどの一般的なテストフレームワークで実装できます。

```python
def normalize_status(s):
    return s.lower().strip()

def test_status():
    assert normalize_status(" Paid ") == "paid"
```

ただし、データエンジニアリング全体の中では、この種のテストは一部に過ぎません。

---

## データエンジニアリングにおけるテストの本質

ソフトウェア開発とデータエンジニアリングでは、テストの目的が異なります。

**ソフトウェア開発**:
> 「コードが正しいか？」

**データエンジニアリング**:
> **「このデータを信じて意思決定して大丈夫か？」**

以下の表に、両者の違いをまとめます：

| ソフトウェア | データ |
|---------|------|
| 正解一致 | 異常検知 |
| ロジック中心 | データの振る舞い中心 |
| deterministic（決定論的） | 統計的・変動前提 |

---

## pytestは無意味か？

pytestは無意味ではありません。**レイヤーが違うだけ**です。

データエンジニアリングでは、レイヤーごとに適切なテストツールを使用します：

| レイヤー | 使用するテスト |
|------|----------|
| ETLロジック | pytest |
| テーブル品質 | dbt test |
| データ監視 | Monte Carlo / Datadog / BigQuery checks |
| ML系 | データドリフト検知 |

---

## 重要なマインドセットの違い

### ソフトウェアテスト
- **目的**: バグを防ぐ

### データテスト
- **目的**: 事故を早期発見する

データテストでは、完全に問題を防ぐことは不可能なため、「監視」の性格が強くなります。

---

